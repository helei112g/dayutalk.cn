<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="He Lei">
  <!-- Open Graph Data -->
  <meta property="og:title" content="Payment：支付宝即时到账接口接入教程"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="大愚Talk｜与你把酒言诗"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://dayutalk.cnundefined"/>
  
    <link rel="alternate" href="/atom.xml" title="大愚Talk｜与你把酒言诗" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>大愚Talk｜与你把酒言诗</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-79844617-1', 'auto');
        ga('send', 'pageview');
    </script>


</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">Payment：支付宝即时到账接口接入教程</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/helei112g">
                  
                  GitHub
                  
                </a>
              </li>
            
              <li>
                <a href="https://juejin.im/user/58c50c75570c35006d632e8e">
                  
                  掘金
                  
                </a>
              </li>
            
              <li>
                <a href="https://segmentfault.com/u/helei112g">
                  
                  SegmentFault
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By He Lei</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-03-11</span>
            <span class="time">20:09:37</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/payment-3/">payment-3</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/支付宝支付/">#支付宝支付</a> <a class="tag" href="/tags/支付宝即时到账/">#支付宝即时到账</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>记住，如果觉得文档写得不清楚，一定要告诉我。励志写好文档为大家服务！</p>
<a id="more"></a>
<hr>
<p><strong><code>Payment 3.0</code></strong> 支付宝的配置设置文档请 <a href="https://helei112g.github.io/2017/03/09/Payment%EF%BC%9A%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AE%BE%E7%BD%AE%E6%95%99%E7%A8%8B/" target="_blank" rel="external">点击这里</a></p>
<p><strong>项目GitHub地址</strong>：<a href="https://github.com/helei112g/payment" target="_blank" rel="external">https://github.com/helei112g/payment</a></p>
<p>支付宝从新版本开始，提供了沙箱方式，方便进行调试。但是，即时到账支付宝没有提供沙箱模式。因此大家在使用过程中，注意设置配置。</p>
<p>我在项目中提供的初始配置也不能用于测试 <strong>即时到账接口</strong>。</p>
<blockquote>
<p>即时到账属于老版本接口。不支持 RSA2 的签名方式，请设置为 RSA 签名方式。</p>
</blockquote>
<p>支付宝的支付种类比较多。先从即时到账开始吧。</p>
<p>即时到账 主要应用于网站支付。当前也可使用支付宝提供的当面付–扫码支付来完成网站支付的业务。</p>
<p>即时到账接口属于支付宝老版本接口，当前 Payment 依然将其进行了保留。后期会跟随支付宝公告进行调整。<br>即时到账的权限需要在支付宝商家平台进行签约。</p>
<p><strong>签约地址:</strong> <a href="https://b.alipay.com/order/productDetail.htm?productId=2015110218012942" target="_blank" rel="external">https://b.alipay.com/order/productDetail.htm?productId=2015110218012942</a></p>
<p>即时到账签约后，默认开通以下两个接口的权限：</p>
<ul>
<li>即时到账交易接口(create_direct_pay_by_user)</li>
<li>即时到账批量退款有密接口(refund_fastpay_by_platform_pwd)</li>
</ul>
<p>但是 <code>Payment3.x</code> 并未接入 <strong>即时到账批量退款有密接口</strong>。大家可以通过 新版退款接口发起退款操作。<br>退款操作文档，可点击这里（TODO）</p>
<p>先上 <strong>即时到账发起支付</strong> 需要的参数列表</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>是否必须</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>body</td>
<td>boolean</td>
<td>是</td>
<td>商品描述</td>
</tr>
<tr>
<td>subject</td>
<td>string</td>
<td>是</td>
<td>商品名称,该参数最长为128个汉字</td>
</tr>
<tr>
<td>order_no</td>
<td>string</td>
<td>是</td>
<td>商户网站唯一订单号</td>
</tr>
<tr>
<td>timeout_express</td>
<td>string</td>
<td>是</td>
<td>设置未付款交易的超时时间，一旦超时，该笔交易就会自动被关闭。</td>
</tr>
<tr>
<td>amount</td>
<td>float</td>
<td>是</td>
<td>该笔订单的资金总额，单位为RMB-Yuan</td>
</tr>
<tr>
<td>return_param</td>
<td>string</td>
<td>是</td>
<td>公用回传参数</td>
</tr>
<tr>
<td>qr_mod</td>
<td>string</td>
<td>否</td>
<td>扫码支付方式</td>
</tr>
<tr>
<td>paymethod</td>
<td>string</td>
<td>否</td>
<td>默认支付方式</td>
</tr>
<tr>
<td>goods_type</td>
<td>string</td>
<td>否</td>
<td>商品主类型：0—虚拟类商品，1—实物类商品 默认为1</td>
</tr>
</tbody>
</table>
<p><strong><code>body</code></strong> 主要是对商品的描述，根据自己的业务写就好，不过不要用一些非常特殊的字符，支付宝可能会进行一些处理，导致你的结果与预期不一样</p>
<p><strong><code>subject</code></strong> 可以写一下商品名称信息，主要是方便支付宝后台对账时查看</p>
<p><strong><code>order_no</code></strong> 自己生成的订单号，每次下单的单号必须唯一。也就是说：同一个 order_no 他的其他下单数据不能发生变化，价格、名称等等。如果有变化，需要重新生成一个订单号。</p>
<p><strong><code>timeout_express</code></strong> 订单过期时间，很简单，你希望在那一刻过期，就写那个点的时间戳。只会精确到分钟</p>
<p><strong><code>amount</code></strong> 订单的金额，就是用户实际需要支付的金额。</p>
<p><strong><code>return_param</code></strong>  希望支付宝异步通知时，原样返回给你的数据，同样注意避免一些特殊字符</p>
<p><strong><code>qr_mod</code></strong> 这个参数可以不设置，如果没有特殊需求建议不设置，可设置：0 1 2 3  。效果可以自己看看</p>
<p><strong><code>paymethod</code></strong> 当用户进行支付时，默认使用的付款方式。可选值：creditPay（信用支付）directPay（余额支付）</p>
<p><strong><code>goods_type</code></strong> 用来区分购买的是实际商品还是虚拟商品，虚拟商品不需要物流发货，并且 虚拟类商品不支持使用花呗渠道</p>
<hr>
<p>ok，以上就是需要发起支付的全部参数了。具体到 sdk 如何调用。看代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">use Payment\Common\PayException;</span><br><span class="line">use Payment\Client\Charge;</span><br><span class="line"></span><br><span class="line">$config = require_once(&apos;./aliconfig.php&apos;);// 这里我假设大家都已经配置好了。不会的请去看配置设置文档</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$channel = &apos;ali_web&apos;;</span><br><span class="line">$payData = [</span><br><span class="line">    // 按照上表格中的信息配置一个数组</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">    $payUrl = Charge::run($channel, $config, $payData);</span><br><span class="line">&#125; catch (PayException $e) &#123;</span><br><span class="line">    // 异常处理</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo htmlspecialchars($payUrl);</span><br></pre></td></tr></table></figure>
<p>即时到账的代码就全部完成了。</p>
<p><code>$payUrl</code>  是跳转向支付宝支付的一个连接。访问该连接即可跳转到支付宝。</p>
<p>接下来说下重点，请仔细往下看。</p>
<blockquote>
<p>这里需要注意的一个点： htmlspecialchars() 函数在正式环境上，如果时进行url的跳转操作，请不要用它进行转义。我这里使用它是为了方便输出到页面上。因为 &amp;not 是一个特殊符号，如果不转移，在网页上无法正常显示。</p>
</blockquote>
<p><code>Payment</code> 的设计思路是将配置文件与下单数据进行了分离。配置文件一般来讲是静态的，不会经常变更，并且大家都会用到。而下单的订单数据则不同，每一个支付接口需要的下单数据不同，并且根据业务，其对应的值也不稳定，常常发生变化。</p>
<p>其次，还有一个 <code>$channel</code> 参数，这个简单来讲，就是用来标记，你现在想要使用那种接口。可以取的参数如下：</p>
<p><em>channel可取值</em></p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ali_web</td>
<td>即时到账</td>
</tr>
<tr>
<td>ali_app</td>
<td>app支付（移动支付）</td>
</tr>
<tr>
<td>ali_wap</td>
<td>H5支付（手机网站支付、wap支付）</td>
</tr>
<tr>
<td>ali_qr</td>
<td>当面付中的扫码支付</td>
</tr>
<tr>
<td>ali_bar</td>
<td>当面付中的条码支付</td>
</tr>
</tbody>
</table>
<p>接下来将说道<a href="https://helei112g.github.io/2017/03/12/Payment%EF%BC%9A%E6%94%AF%E4%BB%98%E5%AE%9D%E6%89%8B%E6%9C%BA%E7%BD%91%E7%AB%99%E6%94%AF%E4%BB%98%E6%95%99%E7%A8%8B/" target="_blank" rel="external">手机网站支付</a>，会给大家说到沙箱的问题</p>

        </div>
      </div>
    </div>
    <!-- 个人信息 -->
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p align="center" style="margin:0;padding:0;"><img src="https://dayutalk.cn/img/mp-qrcode.jpg"></p>
        <p align="center" style="margin:0;padding:0;">个人公众号：<b>dayuTalk</b></p>
        <p align="center" style="margin:0;padding:0;">联系邮箱：dayugog@gmail.com</p>
        <p align="center" style="margin:0;padding:0;">GitHub：<a href="https://github.com/helei112g">https://github.com/helei112g</a></p>
        <p align="center" style="margin:0;padding:0;"><img width="500" src="https://dayutalk.cn/img/pay-qr.jpeg"></p>
        <p align="center" style="margin:0;padding:0;"><b>我写我的，你赏你的</b></p>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
        <p class="copyright text-muted">
          友情链接
          <a target="_blank" href="http://tigerb.cn">Tigerb</a>
          <a target="_blank" href="http://52fhy.com/">飞鸿影</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

